# Releasing elm-wrap

This document describes how to cut a new elm-wrap release and how the Homebrew tap is wired into the process.

The high‑level flow is:

1. Bump the version and push code to `dsimunic/elm-wrap`.
2. Tag the release (`vX.Y.Z`) and push the tag.
3. GitHub Actions builds release binaries and publishes a GitHub Release.
4. A second workflow notifies the Homebrew tap repository.
5. The tap updates the `elm-wrap` formula automatically and pushes the change.

Once everything is green, users can install or upgrade via:

```bash
brew install dsimunic/elm-wrap/elm-wrap
# or
brew upgrade dsimunic/elm-wrap/elm-wrap
```

## Versioning and tagging

- The base version is stored in `VERSION` (e.g. `1.0.0`).
- Git tags are prefixed with `v`, e.g.:
  - `VERSION` file: `1.2.3`
  - Git tag: `v1.2.3`
- Build metadata (commit, timestamp, etc.) is generated by `buildinfo.mk` and embedded into the binary.

### Updating the version

Before cutting a release:

1. Decide on the next semantic version: `MAJOR.MINOR.PATCH`.
2. Edit `VERSION` and set it to the new value (e.g. `1.2.3`).
3. Commit the change along with any other release prep work (docs, fixes, etc.).

Example:

```bash
echo "1.2.3" > VERSION
git commit -am "Bump version to 1.2.3"
git push
```

## Standard release workflow

For a normal release from the `dsimunic/elm-wrap` repository:

1. **Make sure main is clean and green**
   - All intended changes are merged.
   - Optional but recommended: run local checks:
     ```bash
     make clean
     make all
     make check
     ```

2. **Update `VERSION`**
   - As described above, set `VERSION` to the new version and commit.

3. **Push changes**
   - Push the branch (typically `main`) to GitHub:
     ```bash
     git push
     ```

4. **Create and push a tag**
   - Create a tag of the form `vX.Y.Z` matching `VERSION`, and push it:
     ```bash
     git tag v1.2.3
     git push origin v1.2.3
     ```

5. **Let GitHub Actions do the rest**
   - Pushing the tag triggers the automated workflows described below.

## GitHub Actions in the main repo

There are two relevant workflows in `dsimunic/elm-wrap`:

### 1. Release workflow

File: `.github/workflows/release.yml`

Trigger:

- `on: push: tags: - 'v*.*.*'`

Behaviour:

1. Extracts the version from the tag (e.g. `v1.2.3`).
2. Creates a GitHub Release for that tag using `actions/create-release`.
3. Builds and tests on macOS runners:
   - `macos-14` → `elm-wrap-macos-arm64`
   - `macos-15-intel` → `elm-wrap-macos-amd64`
4. Uploads the resulting binaries as release assets named:
   - `elm-wrap-macos-arm64`
   - `elm-wrap-macos-amd64`

This is what the Homebrew tap later downloads and wraps in a formula.

### 2. Homebrew tap trigger

File: `.github/workflows/trigger-tap-update.yml`

Trigger:

- `on: push: tags: - 'v*'`

Behaviour:

1. Extracts the tag into a `version` output (e.g. `v1.2.3`).
2. Sends a `repository_dispatch` event to the tap repository `dsimunic/homebrew-elm-wrap`.

It uses the `TAP_DISPATCH_TOKEN` secret for authentication:

```yaml
env:
  TAP_DISPATCH_TOKEN: ${{ secrets.TAP_DISPATCH_TOKEN }}
```

This secret must be set in the **`dsimunic/elm-wrap`** repository:

- Settings → Secrets and variables → Actions → `TAP_DISPATCH_TOKEN`
- Value: a personal access token with permission to call APIs on `dsimunic/homebrew-elm-wrap`.

The payload sent to the tap repository includes:

- `event_type: "elm-wrap-release"`
- `client_payload.version: "vX.Y.Z"`

## Homebrew tap automation

The Homebrew tap lives in a separate repository:

- GitHub repo: `dsimunic/homebrew-elm-wrap`
- Contains:
  - `Formula/elm-wrap.rb`
  - `.github/workflows/update-elm-wrap.yml`

### Tap formula

File: `Formula/elm-wrap.rb`

This Homebrew formula:

- Declares the package metadata (description, homepage, license, version).
- Defines macOS URLs and SHA256 checksums for:
  - `elm-wrap-macos-arm64`
  - `elm-wrap-macos-amd64`
- Installs the appropriate binary as `elm-wrap` in `bin`.
- Includes a basic test:
  - Runs `elm-wrap --help` and checks the output.

The formula is **auto‑generated** by the tap workflow described below and should not need manual editing for normal releases.

### Tap update workflow

File (in the tap repo): `.github/workflows/update-elm-wrap.yml`

Trigger:

- `on: repository_dispatch: types: [elm-wrap-release]`

Behaviour:

1. **Checkout tap repo**
   - Uses `actions/checkout` to pull the tap contents.

2. **Read version from dispatch payload**
   - Uses `github.event.client_payload.version` (e.g. `v1.2.3`).
   - Strips the `v` prefix to get `1.2.3` for the formula’s `version` field.

3. **Download release binaries and compute SHAs**
   - Downloads from the main repo release:
     - `https://github.com/dsimunic/elm-wrap/releases/download/vX.Y.Z/elm-wrap-macos-arm64`
     - `https://github.com/dsimunic/elm-wrap/releases/download/vX.Y.Z/elm-wrap-macos-amd64`
   - Computes SHA256 checksums for both files.

4. **Rewrite `Formula/elm-wrap.rb`**
   - Updates:
     - `version` to `X.Y.Z`.
     - `url` fields to point at the new tag.
     - `sha256` fields with the newly computed values.

5. **Commit and push**
   - Uses the standard `GITHUB_TOKEN` for the tap repo with `contents: write` permission.
   - Commits the updated formula with a message like `elm-wrap X.Y.Z`.
   - Pushes back to `dsimunic/homebrew-elm-wrap`.

The result: after a new tag is pushed in `dsimunic/elm-wrap`, the tap’s formula is automatically updated to point at the new release binaries.

## Verifying a release

After pushing a new tag, you can verify the release in three places:

### 1. Main repo: GitHub Release and binaries

In `dsimunic/elm-wrap`:

1. Check **Actions**:
   - The `Release` workflow should have run for tag `vX.Y.Z`.
   - Confirm the build and tests succeeded on both macOS runners.

2. Check **Releases**:
   - A new release for `vX.Y.Z` should exist.
   - Assets should include:
     - `elm-wrap-macos-arm64`
     - `elm-wrap-macos-amd64`

3. Optional: download and test the binary locally:
   ```bash
   curl -L -o elm-wrap \
     https://github.com/dsimunic/elm-wrap/releases/download/vX.Y.Z/elm-wrap-macos-arm64
   chmod +x elm-wrap
   ./elm-wrap --version
   ```

### 2. Tap repo: formula update

In `dsimunic/homebrew-elm-wrap`:

1. Check **Actions**:
   - The `Update elm-wrap formula` workflow should have run, triggered by `repository_dispatch`.
   - Confirm it completed successfully.

2. Check **Commits / Files**:
   - There should be a new commit updating `Formula/elm-wrap.rb`.
   - The `version`, `url` and `sha256` values should match the new release.

### 3. Homebrew install / upgrade

On a machine with Homebrew:

```bash
brew update
brew install dsimunic/elm-wrap/elm-wrap      # fresh install
# or
brew upgrade dsimunic/elm-wrap/elm-wrap     # upgrade existing install
```

Then verify:

```bash
elm-wrap --help
elm-wrap --version
```

If `elm-wrap --version` includes the correct base version (e.g. `1.2.3`), the release and tap are in sync.

## One-time setup vs ongoing releases

**One-time setup (already done if everything is working):**

- Configure `release.yml` and `trigger-tap-update.yml` in `dsimunic/elm-wrap`.
- Configure `update-elm-wrap.yml` and `Formula/elm-wrap.rb` in `dsimunic/homebrew-elm-wrap`.
- Create a fine‑grained personal access token with access to `dsimunic/homebrew-elm-wrap`.
- Add this PAT as `TAP_DISPATCH_TOKEN` secret in `dsimunic/elm-wrap`.

**Ongoing release steps:**

1. Bump `VERSION`, commit, and push.
2. Tag the release (`vX.Y.Z`) and push the tag.
3. Wait for:
   - `Release` workflow (main repo) to finish.
   - `Update elm-wrap formula` workflow (tap repo) to finish.
4. Verify via Homebrew (`brew install` / `brew upgrade` and `elm-wrap --version`).

## Troubleshooting

- **Tap formula not updated**
  - Check `Trigger Tap Update` workflow in `dsimunic/elm-wrap`:
    - Ensure it ran for your tag.
    - Look for errors related to `TAP_DISPATCH_TOKEN` (missing or insufficient permissions).
  - Check `Update elm-wrap formula` workflow in `dsimunic/homebrew-elm-wrap`:
    - Confirm it ran and see logs for download/sha/commit steps.

- **Checksum mismatch in Homebrew**
  - Likely the release binaries were changed after the tap updated the formula.
  - Re-run the tap workflow (or retrigger via a new tag) after the binaries are final.

- **Release workflow fails**
  - Fix the underlying build/test issue in `dsimunic/elm-wrap`.
  - Push a new commit and tag (e.g. bump patch to `vX.Y.(Z+1)`).

This process keeps the elm-wrap binary releases, GitHub Releases, and Homebrew tap formula all in sync with a single `git tag` operation. 

