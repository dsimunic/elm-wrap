#!/usr/bin/env bash
#
# test-cache-happy - Cache command happy path tests
#
# This script tests successful cache operations.
# Uses WRAP_OFFLINE_MODE=0 to allow online package downloads from GitHub,
# but WRAP_SKIP_REGISTRY_UPDATE=1 (from driver) prevents the 16k+ registry update.
#

set -euo pipefail

# Allow online package downloads (registry update is skipped via WRAP_SKIP_REGISTRY_UPDATE=1)
export WRAP_OFFLINE_MODE=0

# =============================================================================
# Test Cases
# =============================================================================

# CACHE-01: Cache single package
test_cache_01_single_package() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)
    
    echo "=== BEGIN CACHE-01: Cache single package ==="
    
    # Create app directory (we don't need an initialized app, just a working dir)
    local work_dir="$TEST_ROOT/cache01"
    mkdir -p "$work_dir"
    cd "$work_dir"
    
    # Cache a package (downloads from GitHub if not already cached)
    run_wrap package cache elm/core
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END CACHE-01 ==="
    echo
}

# CACHE-02: Cache multiple packages at once
test_cache_02_multiple_packages() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)
    
    echo "=== BEGIN CACHE-02: Cache multiple packages at once ==="
    
    local work_dir="$TEST_ROOT/cache02"
    mkdir -p "$work_dir"
    cd "$work_dir"
    
    # Cache multiple packages (downloads from GitHub if not already cached)
    run_wrap package cache elm/bytes elm/json
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END CACHE-02 ==="
    echo
}

# CACHE-03: Cache specific version
test_cache_03_specific_version() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)
    
    echo "=== BEGIN CACHE-03: Cache specific version ==="
    
    local work_dir="$TEST_ROOT/cache03"
    mkdir -p "$work_dir"
    cd "$work_dir"
    
    # Cache specific version (downloads from GitHub if not already cached)
    run_wrap package cache elm/core@1.0.5
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END CACHE-03 ==="
    echo
}

# CACHE-04: Cache package that's already in cache (should be idempotent)
test_cache_04_already_cached() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)
    
    echo "=== BEGIN CACHE-04: Cache package that's already in cache ==="
    
    local work_dir="$TEST_ROOT/cache04"
    mkdir -p "$work_dir"
    cd "$work_dir"
    
    # Cache package once (downloads from GitHub if not already cached)
    run_wrap package cache elm/core
    
    # Cache same package again (should not re-download)
    run_wrap package cache elm/core
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END CACHE-04 ==="
    echo
}

# CACHE-05: Cache from file/directory
test_cache_05_from_file() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)
    
    echo "=== BEGIN CACHE-05: Cache from file/directory ==="
    
    local work_dir="$TEST_ROOT/cache05"
    mkdir -p "$work_dir"
    cd "$work_dir"
    
    # Path to test package
    local pkg_path="$PROJECT_ROOT/test/data/packages/install-uninstall/wrap/package-from-file-single-no-deps"
    
    # Cache from local directory
    run_wrap package cache --from-file "$pkg_path" wrap/package-from-file-single-no-deps
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END CACHE-05 ==="
    echo
}

# =============================================================================
# Main
# =============================================================================

main() {
    echo "Running cache-happy tests..."
    echo
    echo
    
    # Run all test cases
    test_cache_01_single_package
    test_cache_02_multiple_packages
    test_cache_03_specific_version
    test_cache_04_already_cached
    test_cache_05_from_file
    
    local since_after delta
    since_after=$(get_v1_since_count)
    delta=0
    echo
    echo "[Registry since-count: $since_after -> $since_after (Δ$delta)]"
    echo "=== END ==="
    echo
    echo "All cache-happy tests completed successfully"
}

main "$@"
