#!/usr/bin/env bash
#
# test-upgrade-unhappy - Upgrade command error cases
#
# This script tests upgrade operations that should fail.
#

set -euo pipefail

# =============================================================================
# Test Cases
# =============================================================================

# ERR-01: Upgrade non-existent package (should fail)
test_err_01_upgrade_nonexistent_package() {
    echo "=== BEGIN ERR-01: Upgrade non-existent package ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err01" "err01")
    
    # Try to upgrade non-existent package (should fail)
    cd "$app_dir"
    if run_wrap package upgrade wrap/does-not-exist 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify dependencies unchanged
    assert_no_dep "wrap/does-not-exist" "$app_dir"
    
    echo "=== END ERR-01 ==="
}

# ERR-02: Upgrade package not in dependencies (should fail)
test_err_02_upgrade_not_in_dependencies() {
    echo "=== BEGIN ERR-02: Upgrade package not in dependencies ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err02" "err02")
    
    # Install one package
    cd "$app_dir"
    run_wrap install wrap/package-single-no-deps
    
    # Try to upgrade a different package (should fail)
    if run_wrap package upgrade wrap/package-3v-no-deps 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify original dependency still there
    assert_direct_dep "wrap/package-single-no-deps" "1.0.0" "$app_dir"
    
    echo "=== END ERR-02 ==="
}

# =============================================================================
# Main
# =============================================================================

main() {
    echo "Running upgrade-unhappy tests..."
    echo
    
    # Run all test cases
    test_err_01_upgrade_nonexistent_package
    test_err_02_upgrade_not_in_dependencies
    
    echo
    echo "All upgrade-unhappy tests completed successfully"
}

main "$@"