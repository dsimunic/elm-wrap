#!/usr/bin/env bash
#
# test-upgrade-unhappy - Upgrade command error cases
#
# This script tests upgrade operations that should fail.
#

set -euo pipefail

# =============================================================================
# Test Cases
# =============================================================================

get_v1_since_count() {
    local out
    out=$(run_wrap debug registry_v1 list | head -4)
    echo "$out" | awk -F': ' '/^Since count: /{print $2; exit}'
}

# ERR-01: Upgrade non-existent package (should fail)
test_err_01_upgrade_nonexistent_package() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN ERR-01: Upgrade non-existent package ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err01" "err01")
    
    # Try to upgrade non-existent package (should fail)
    cd "$app_dir"
    if run_wrap package upgrade wrap/does-not-exist 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify dependencies unchanged
    assert_no_dep "wrap/does-not-exist" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END ERR-01 ==="
    echo
}

# ERR-02: Upgrade package not in dependencies (should fail)
test_err_02_upgrade_not_in_dependencies() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN ERR-02: Upgrade package not in dependencies ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err02" "err02")
    
    # Install one package
    cd "$app_dir"
    run_wrap install wrap/package-single-no-deps
    
    # Try to upgrade a different package (should fail)
    if run_wrap package upgrade wrap/package-3v-no-deps 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify original dependency still there
    assert_direct_dep "wrap/package-single-no-deps" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END ERR-02 ==="
    echo
}

# =============================================================================
# Main
# =============================================================================

main() {
    echo "Running upgrade-unhappy tests..."
    echo
    echo
    
    # Run all test cases
    test_err_01_upgrade_nonexistent_package
    test_err_02_upgrade_not_in_dependencies
    
    local since_after delta
    since_after=$(get_v1_since_count)
    delta=0
    echo
    echo "[Registry since-count: $since_after -> $since_after (Δ$delta)]"
    echo "=== END ==="
    echo
    echo "All upgrade-unhappy tests completed successfully"
}

main "$@"