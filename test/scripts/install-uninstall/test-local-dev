#!/usr/bin/env bash
#
# test-local-dev - Local development workflow tests
#
# This script tests local development features like --local-dev, --from-path, etc.
#

set -euo pipefail

# =============================================================================
# Test Cases
# =============================================================================

get_v1_since_count() {
    local out
    out=$(run_wrap debug registry_v1 list | head -4)
    echo "$out" | awk -F': ' '/^Since count: /{print $2; exit}'
}

# LOCAL-01: Initialize package with local-dev and install to app
test_local_01_init_and_install() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN LOCAL-01: Initialize package with local-dev and install to app ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/local-pkg1" "testauthor/local-pkg1")
    
    # Register for local-dev (from within package directory)
    cd "$pkg_dir"
    run_wrap install --local-dev
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app01" "app01")
    
    # Install from path
    cd "$app_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/local-pkg1
    
    # Verify local-dev dependency
    assert_direct_dep "testauthor/local-pkg1" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END LOCAL-01 ==="
    echo
}

# LOCAL-02: Install package with --local-dev --from-path
test_local_02_install_from_path() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN LOCAL-02: Install package with --local-dev --from-path ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/local-src2" "testauthor/local-src2")
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app02" "app02")
    
    # Install from path
    cd "$app_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/local-src2
    
    # Verify local-dev dependency
    assert_direct_dep "testauthor/local-src2" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END LOCAL-02 ==="
    echo
}

# LOCAL-03: Dependency synchronization when local package changes
test_local_03_dependency_sync() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN LOCAL-03: Dependency synchronization when local package changes ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/local-pkg3" "testauthor/local-pkg3")
    
    # Register for local-dev
    cd "$pkg_dir"
    run_wrap install --local-dev
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app03" "app03")
    
    # Install local package
    cd "$app_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/local-pkg3
    
    # Verify initial state
    assert_direct_dep "testauthor/local-pkg3" "1.0.0" "$app_dir"
    
    # Modify local package to add dependency (simulate adding wrap/package-single-no-deps)
    # Note: In a real test, we'd modify elm.json, but for now we just test the mechanism
    
    # Re-install should sync dependencies
    run_wrap install testauthor/local-pkg3
    
    # Verify dependency sync worked (would include new deps if elm.json changed)
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END LOCAL-03 ==="
    echo
}

# LOCAL-04: Multiple applications depending on same local package
test_local_04_multiple_apps_same_local() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN LOCAL-04: Multiple applications depending on same local package ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/local-pkg4" "testauthor/local-pkg4")
    
    # Register for local-dev
    cd "$pkg_dir"
    run_wrap install --local-dev
    
    # Create first app
    local app1_dir
    app1_dir=$(create_app "$TEST_ROOT/app04a" "app04a")
    
    # Install local package to first app
    cd "$app1_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/local-pkg4
    
    # Create second app
    local app2_dir
    app2_dir=$(create_app "$TEST_ROOT/app04b" "app04b")
    
    # Install local package to second app
    cd "$app2_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/local-pkg4
    
    # Verify both apps have the dependency
    assert_direct_dep "testauthor/local-pkg4" "1.0.0" "$app1_dir"
    assert_direct_dep "testauthor/local-pkg4" "1.0.0" "$app2_dir"
    
    # Modify and sync both apps
    run_wrap install testauthor/local-pkg4
    
    # Verify both still have the dependency
    assert_direct_dep "testauthor/local-pkg4" "1.0.0" "$app1_dir"
    assert_direct_dep "testauthor/local-pkg4" "1.0.0" "$app2_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END LOCAL-04 ==="
    echo
}

# LOCAL-05: Remove local-dev tracking with uninstall --local-dev
test_local_05_remove_local_dev_tracking() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN LOCAL-05: Remove local-dev tracking with uninstall --local-dev ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/local-pkg5" "testauthor/local-pkg5")
    
    # Register for local-dev
    cd "$pkg_dir"
    run_wrap install --local-dev
    
    # Remove local-dev tracking
    run_wrap uninstall --local-dev

    local registry_after
    registry_after=$(run_wrap debug registry_v1 list)
    if echo "$registry_after" | grep -q "^testauthor/local-pkg5$"; then
        echo "ERROR: Expected local-dev version to be removed from registry.dat"
        exit 1
    fi
    
    # Try to remove again (should be idempotent)
    run_wrap uninstall --local-dev
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END LOCAL-05 ==="
    echo
}

# LOCAL-06: Registry since_count stability + /since advancement rules
test_local_06_registry_since_count() {
    echo "=== BEGIN LOCAL-06: Registry since_count stability + /since advancement rules ==="

    local since_before
    since_before=$(get_v1_since_count)

    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/local-since" "testauthor/local-since")

    # Register for local-dev (from within package directory)
    cd "$pkg_dir"
    run_wrap install --local-dev

    local since_after_local
    since_after_local=$(get_v1_since_count)

    if [[ "$since_after_local" != "$since_before" ]]; then
        echo "ERROR: since_count changed after local-dev registration ($since_before -> $since_after_local)"
        exit 1
    fi

    # Apply a /since response that includes a duplicate of the local version plus one new version.
    local since_json="$TEST_ROOT/since.json"
    cat >"$since_json" <<'EOF'
[
  "testauthor/local-since@1.0.0",
  "testauthor/local-since@1.0.1"
]
EOF

    run_wrap debug registry_v1 apply-since "$since_json"

    local since_after_since
    since_after_since=$(get_v1_since_count)

    local expected_since
    expected_since=$((since_before + 2))

    if [[ "$since_after_since" != "$expected_since" ]]; then
        echo "ERROR: since_count did not advance by /since response length (expected $expected_since, got $since_after_since)"
        exit 1
    fi

    echo "=== END LOCAL-06 ==="
    echo
}

# ERR-01: Install with --local-dev --from-path with non-existent path
test_err_01_local_dev_nonexistent_path() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN ERR-01: Install with --local-dev --from-path with non-existent path ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err01" "err01")
    
    # Try to install from non-existent path (should fail)
    cd "$app_dir"
    if run_wrap install --local-dev --from-path "$TEST_ROOT/does-not-exist" testauthor/does-not-exist 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify dependencies unchanged
    assert_no_dep "testauthor/does-not-exist" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END ERR-01 ==="
    echo
}

# ERR-02: Install multiple packages with --local-dev (should fail)
test_err_02_local_dev_multiple_packages() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN ERR-02: Install multiple packages with --local-dev (should fail) ==="
    
    # Create packages
    local pkg1_dir
    pkg1_dir=$(create_package "$TEST_ROOT/err02-pkg1" "testauthor/err02-pkg1")
    create_package "$TEST_ROOT/err02-pkg2" "testauthor/err02-pkg2" >/dev/null
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err02" "err02")
    
    # Try to install multiple with --local-dev (should fail)
    cd "$app_dir"
    if run_wrap install --local-dev --from-path "$pkg1_dir" testauthor/err02-pkg1 testauthor/err02-pkg2 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify dependencies unchanged
    assert_no_dep "testauthor/err02-pkg1" "$app_dir"
    assert_no_dep "testauthor/err02-pkg2" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END ERR-02 ==="
    echo
}

# ERR-03: Use --from-path without --local-dev (should fail)
test_err_03_from_path_without_local_dev() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN ERR-03: Use --from-path without --local-dev (should fail) ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/err03" "err03")
    
    # Try to use --from-path without --local-dev (should fail)
    cd "$app_dir"
    if run_wrap install --from-path "$TEST_ROOT/some-path" testauthor/some-pkg 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify dependencies unchanged
    assert_no_dep "testauthor/some-pkg" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END ERR-03 ==="
    echo
}

# MAKE-01: Local-dev package compiles successfully with make
test_make_01_compile_success() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN MAKE-01: Local-dev package compiles successfully with make ==="

    # Create package with valid Elm code
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/make-pkg1" "testauthor/make-pkg1")

    # Add a valid module
    mkdir -p "$pkg_dir/src"
    cat > "$pkg_dir/src/ValidModule.elm" << 'EOF'
module ValidModule exposing (greet)

greet : String -> String
greet name =
    "Hello, " ++ name
EOF

    # Update elm.json to expose the module
    cd "$pkg_dir"
    cat > elm.json << 'EOF'
{
    "type": "package",
    "name": "testauthor/make-pkg1",
    "version": "1.0.0",
    "license": "BSD-3-Clause",
    "summary": "Test package",
    "exposed-modules": ["ValidModule"],
    "elm-version": "0.19.1 <= v < 0.20.0",
    "dependencies": {
        "elm/core": "1.0.0 <= v < 2.0.0"
    },
    "test-dependencies": {}
}
EOF

    # Register for local-dev
    run_wrap install --local-dev

    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/make-app01" "make-app01")

    # Install local package
    cd "$app_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/make-pkg1

    # Create Main.elm that uses the package
    cat > src/Main.elm << 'EOF'
module Main exposing (main)

import Html exposing (Html, text)
import ValidModule

main : Html msg
main =
    text (ValidModule.greet "World")
EOF

    # Run make - should succeed
    if ! run_wrap make src/Main.elm --output=/dev/null; then
        echo "ERROR: Expected make to succeed"
        exit 1
    fi

    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END MAKE-01 ==="
    echo
}

# MAKE-02: Local-dev package with compilation error
test_make_02_compile_error() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN MAKE-02: Local-dev package with compilation error ==="

    # Create package with type error
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/make-pkg2" "testauthor/make-pkg2")

    # Add a module with type error
    mkdir -p "$pkg_dir/src"
    cat > "$pkg_dir/src/BrokenModule.elm" << 'EOF'
module BrokenModule exposing (broken)

broken : String
broken =
    42
EOF

    # Update elm.json to expose the module
    cd "$pkg_dir"
    cat > elm.json << 'EOF'
{
    "type": "package",
    "name": "testauthor/make-pkg2",
    "version": "1.0.0",
    "license": "BSD-3-Clause",
    "summary": "Test package",
    "exposed-modules": ["BrokenModule"],
    "elm-version": "0.19.1 <= v < 0.20.0",
    "dependencies": {
        "elm/core": "1.0.0 <= v < 2.0.0"
    },
    "test-dependencies": {}
}
EOF

    # Register for local-dev
    run_wrap install --local-dev

    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/make-app02" "make-app02")

    # Install local package
    cd "$app_dir"
    run_wrap install --local-dev --from-path "$pkg_dir" testauthor/make-pkg2

    # Create Main.elm
    cat > src/Main.elm << 'EOF'
module Main exposing (main)

import Html exposing (Html, text)

main : Html msg
main =
    text "Test"
EOF

    # Run make - should fail with human-friendly error
    local output
    output=$(run_wrap make src/Main.elm --output=/dev/null 2>&1 || true)

    if echo "$output" | grep -q "Local-dev package compilation failed"; then
        echo "SUCCESS: Detected compilation failure"
    else
        echo "ERROR: Expected 'Local-dev package compilation failed' in output"
        echo "$output"
        exit 1
    fi

    if echo "$output" | grep -q "TYPE MISMATCH"; then
        echo "SUCCESS: Got human-friendly error output (not JSON)"
    else
        echo "ERROR: Expected human-friendly error output"
        echo "$output"
        exit 1
    fi

    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END MAKE-02 ==="
    echo
}

# MAKE-03: Application without local-dev packages
test_make_03_no_local_dev() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN MAKE-03: Application without local-dev packages ==="

    # Create app without local-dev dependencies
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/make-app03" "make-app03")

    cd "$app_dir"

    # Create simple Main.elm
    cat > src/Main.elm << 'EOF'
module Main exposing (main)

import Html exposing (Html, text)

main : Html msg
main =
    text "Hello"
EOF

    # Run make - should succeed without any local-dev compilation
    if ! run_wrap make src/Main.elm --output=/dev/null; then
        echo "ERROR: Expected make to succeed"
        exit 1
    fi

    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END MAKE-03 ==="
    echo
}

# =============================================================================
# Main
# =============================================================================

main() {
    echo "Running local-dev tests..."
    echo
    echo

    # Run all test cases
    test_local_01_init_and_install
    test_local_02_install_from_path
    test_local_03_dependency_sync
    test_local_04_multiple_apps_same_local
    test_local_05_remove_local_dev_tracking
    test_err_01_local_dev_nonexistent_path
    test_err_02_local_dev_multiple_packages
    test_err_03_from_path_without_local_dev
    test_local_06_registry_since_count
    test_make_01_compile_success
    test_make_02_compile_error
    test_make_03_no_local_dev

    local since_after delta
    since_after=$(get_v1_since_count)
    delta=0
    echo
    echo "[Registry since-count: $since_after -> $since_after (Δ$delta)]"
    echo "=== END ==="
    echo
    echo "All local-dev tests completed successfully"
}

main "$@"
