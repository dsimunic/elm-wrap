#!/usr/bin/env bash
#
# test-install-happy - Install command happy path tests
#
# This script tests successful install operations for both applications and packages.
#

set -euo pipefail

# =============================================================================
# Test Cases
# =============================================================================

get_v1_since_count() {
    local out
    out=$(run_wrap debug registry_v1 list | head -4)
    echo "$out" | awk -F': ' '/^Since count: /{print $2; exit}'
}

# APP-01: single package install
test_app_01_single_package_install() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-01: single package install ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app01" "app01")
    
    # Install package
    cd "$app_dir"
    run_wrap install wrap/package-single-no-deps
    
    # Verify direct dependency
    assert_direct_dep "wrap/package-single-no-deps" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-01 ==="
    echo
}

# APP-02: install multiple packages at once
test_app_02_install_multiple_packages() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-02: install multiple packages at once ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app02" "app02")
    
    # Install multiple packages
    cd "$app_dir"
    run_wrap install wrap/package-single-no-deps wrap/package-3v-no-deps
    
    # Verify direct dependencies
    assert_direct_dep "wrap/package-single-no-deps" "1.0.0" "$app_dir"
    assert_direct_dep "wrap/package-3v-no-deps" "3.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-02 ==="
    echo
}

# APP-03: Install package with targeted version (PACKAGE@VERSION)
test_app_03_install_targeted_version() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-03: Install package with targeted version ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app03" "app03")
    
    # Install specific version
    cd "$app_dir"
    run_wrap install wrap/package-3v-no-deps@2.0.0
    
    # Verify direct dependency with correct version
    assert_direct_dep "wrap/package-3v-no-deps" "2.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-03 ==="
    echo
}

# APP-04: Install package with dependencies
test_app_04_install_with_dependencies() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-04: Install package with dependencies ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app04" "app04")
    
    # Install package that has dependencies
    cd "$app_dir"
    run_wrap install wrap/package-single-1d
    
    # Verify direct and indirect dependencies
    assert_direct_dep "wrap/package-single-1d" "1.0.0" "$app_dir"
    assert_indirect_dep "wrap/dep-single-no-deps" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-04 ==="
    echo
}

# APP-05: Move package from indirect to direct
test_app_05_move_indirect_to_direct() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-05: Move package from indirect to direct ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app05" "app05")
    
    # First install a package that brings in wrap/dep-single-no-deps as indirect
    cd "$app_dir"
    run_wrap install wrap/package-single-1d
    
    # Verify it's indirect
    assert_indirect_dep "wrap/dep-single-no-deps" "1.0.0" "$app_dir"
    assert_no_dep "wrap/dep-single-no-deps" "$app_dir"  # Not direct
    
    # Now install it directly
    run_wrap install wrap/dep-single-no-deps
    
    # Verify it's now direct (and still indirect from the other package)
    assert_direct_dep "wrap/dep-single-no-deps" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-05 ==="
    echo
}

# APP-07: Install multiple packages with mixed version specifications
test_app_07_mixed_version_specs() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-07: Install multiple packages with mixed version specifications ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app07" "app07")
    
    # Install with mixed version specs
    cd "$app_dir"
    run_wrap install wrap/package-3v-no-deps@2.0.0 wrap/package-single-no-deps wrap/package-single-1d
    
    # Verify all dependencies
    assert_direct_dep "wrap/package-3v-no-deps" "2.0.0" "$app_dir"
    assert_direct_dep "wrap/package-single-no-deps" "1.0.0" "$app_dir"
    assert_direct_dep "wrap/package-single-1d" "1.0.0" "$app_dir"
    assert_indirect_dep "wrap/dep-single-no-deps" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-07 ==="
    echo
}

# APP-08: Re-install does not cross major without --major
test_app_08_reinstall_no_cross_major() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-08: Re-install does not cross major without --major ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app08" "app08")
    
    # Install specific version first
    cd "$app_dir"
    run_wrap install wrap/package-3v-no-deps@2.0.0
    
    # Verify version
    assert_direct_dep "wrap/package-3v-no-deps" "2.0.0" "$app_dir"
    
    # Try to install without version (should stay at 2.0.0)
    run_wrap install wrap/package-3v-no-deps
    
    # Verify still at 2.0.0 (no major version upgrade)
    assert_direct_dep "wrap/package-3v-no-deps" "2.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-08 ==="
    echo
}

# APP-09: Re-install crosses major with --major (single package)
test_app_09_reinstall_cross_major() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-09: Re-install crosses major with --major ==="
    
    # Depends on APP-08
    local app_dir="$TEST_ROOT/app08"
    
    # Install with --major (should upgrade to 3.0.0)
    cd "$app_dir"
    run_wrap install --major wrap/package-3v-no-deps
    
    # Verify upgraded to 3.0.0
    assert_direct_dep "wrap/package-3v-no-deps" "3.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-09 ==="
    echo
}

# APP-10: Install as test dependency (--test)
test_app_10_install_as_test_dep() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-10: Install as test dependency (--test) ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app10" "app10")
    
    # Install as test dependency
    cd "$app_dir"
    run_wrap install --test wrap/package-single-no-deps
    
    # Verify it's in test dependencies, not production
    # Note: We can't easily check test vs prod deps with current helpers
    # This test mainly verifies the command doesn't fail
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-10 ==="
    echo
}

# APP-11: Install test dep requiring prod upgrade (requires --upgrade-all)
test_app_11_test_dep_requires_prod_upgrade() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-11: Install test dep requiring prod upgrade ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app11" "app11")
    
    # Install older version of prod dep first
    cd "$app_dir"
    run_wrap install wrap/package-3v-no-deps@1.0.0
    
    # Verify version
    assert_direct_dep "wrap/package-3v-no-deps" "1.0.0" "$app_dir"
    
    # Try to install test dep that requires newer prod version (should fail)
    if run_wrap install --test wrap/testdep-req-newer-prod-single 2>/dev/null; then
        echo "ERROR: Expected command to fail"
        exit 1
    fi
    
    # Verify prod dep still at old version
    assert_direct_dep "wrap/package-3v-no-deps" "1.0.0" "$app_dir"
    
    # Now try with --upgrade-all (should succeed and upgrade prod dep)
    run_wrap install --test --upgrade-all wrap/testdep-req-newer-prod-single
    
    # Verify prod dep was upgraded
    assert_direct_dep "wrap/package-3v-no-deps" "3.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-11 ==="
    echo
}

# PKG-01: Install single package to package type
test_pkg_01_install_single_to_package() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN PKG-01: Install single package to package type ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/pkg01" "testauthor/pkg01")
    
    # Install package (adds constraint to elm.json)
    cd "$pkg_dir"
    run_wrap package install wrap/package-single-no-deps
    
    # Verify constraint was added (can't easily check elm.json with current helpers)
    # This test mainly verifies the command doesn't fail
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END PKG-01 ==="
    echo
}

# PKG-02: Install multiple packages to package type
test_pkg_02_install_multiple_to_package() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN PKG-02: Install multiple packages to package type ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/pkg02" "testauthor/pkg02")
    
    # Install multiple packages
    cd "$pkg_dir"
    run_wrap package install wrap/package-single-no-deps wrap/package-3v-no-deps
    
    # Verify constraints were added
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END PKG-02 ==="
    echo
}

# PKG-03: Install package with targeted version to package type
test_pkg_03_install_targeted_version_to_package() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN PKG-03: Install package with targeted version to package type ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/pkg03" "testauthor/pkg03")
    
    # Install with specific version
    cd "$pkg_dir"
    run_wrap package install wrap/package-3v-no-deps@2.0.0
    
    # Verify constraint was added with correct lower bound
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END PKG-03 ==="
    echo
}

# PKG-04: Install package with dependencies to package type
test_pkg_04_install_with_deps_to_package() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN PKG-04: Install package with dependencies to package type ==="
    
    # Create package
    local pkg_dir
    pkg_dir=$(create_package "$TEST_ROOT/pkg04" "testauthor/pkg04")
    
    # Install package with dependencies
    cd "$pkg_dir"
    run_wrap package install wrap/package-single-1d
    
    # Verify only the requested package constraint was added (not transitive deps)
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END PKG-04 ==="
    echo
}

# APP-12: Install from local file/directory (--from-file)
test_app_12_install_from_file() {
    local since_before since_after delta
    since_before=$(get_v1_since_count)

    echo "=== BEGIN APP-12: Install from local file/directory (--from-file) ==="
    
    # Create app
    local app_dir
    app_dir=$(create_app "$TEST_ROOT/app12" "app12")
    
    # Path to test package
    local pkg_path="$PROJECT_ROOT/test/data/packages/install-uninstall/wrap/package-from-file-single-no-deps"
    
    # Install from local directory
    cd "$app_dir"
    run_wrap install --from-file "$pkg_path" wrap/package-from-file-single-no-deps
    
    # Verify direct dependency
    assert_direct_dep "wrap/package-from-file-single-no-deps" "1.0.0" "$app_dir"
    
    since_after=$(get_v1_since_count)
    delta=$((since_after - since_before))
    echo "[Registry since-count: $since_before -> $since_after (Δ$delta)]"
    echo "=== END APP-12 ==="
    echo
}

# =============================================================================
# Main
# =============================================================================

main() {
    echo "Running install-happy tests..."
    echo
    echo
    
    # Run all test cases
    test_app_01_single_package_install
    test_app_02_install_multiple_packages
    test_app_03_install_targeted_version
    test_app_04_install_with_dependencies
    test_app_05_move_indirect_to_direct
    test_app_07_mixed_version_specs
    test_app_08_reinstall_no_cross_major
    test_app_09_reinstall_cross_major
    test_app_10_install_as_test_dep
    test_app_11_test_dep_requires_prod_upgrade
    test_app_12_install_from_file
    test_pkg_01_install_single_to_package
    test_pkg_02_install_multiple_to_package
    test_pkg_03_install_targeted_version_to_package
    test_pkg_04_install_with_deps_to_package
    
    local since_after delta
    since_after=$(get_v1_since_count)
    delta=0
    echo
    echo "[Registry since-count: $since_after -> $since_after (Δ$delta)]"
    echo "=== END ==="
    echo
    echo "All install-happy tests completed successfully"
}

main "$@"